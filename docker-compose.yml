services:
  common-api:
    # Use pre-built image (uncomment to use published image instead of building)
    # image: nibbio84/common-api:latest
    # pull_policy: always
    build:
      context: .
      dockerfile: Dockerfile
    container_name: common-api
    ports:
      - "8181:8181"
    volumes:
      - ./application.properties:/app/application.properties:ro
    environment:
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_USER=${MAIL_USER}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8181/health"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3

  alesco-cron:
    image: alpine:latest
    container_name: common-api-cron
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl tzdata
        echo "#!/bin/sh" > /usr/local/bin/curl-job.sh
        echo "echo \"[\$(date '+%Y-%m-%d %H:%M:%S')] Running curl http://common-api:8181/message\"" >> /usr/local/bin/curl-job.sh
        echo "curl -w \"\\nHTTP Status: %{http_code}\\n\" -s -X POST -H \"Message-Name: Canary\" -H \"Message-Mail: nibbio84@gmail.com\" -H \"Message-Subject: Test della domenica\" -H \"Message-Text: Ciao, se vedete questo messaggio, il sistema di invio email funziona.\" http://common-api:8181/message" >> /usr/local/bin/curl-job.sh
        echo "echo \"----------------------------------------\"" >> /usr/local/bin/curl-job.sh
        echo "--- /usr/local/bin/curl-job.sh"
        cat /usr/local/bin/curl-job.sh
        echo "---"
        chmod +x /usr/local/bin/curl-job.sh
        echo "TZ=Europe/Rome" > /etc/crontabs/root
        echo "$${CRON_SCHEDULE} /usr/local/bin/curl-job.sh > /proc/1/fd/1 2>&1" >> /etc/crontabs/root
        echo "Cron job configured: $${CRON_SCHEDULE}"
        echo "--- /etc/crontabs/root"
        cat /etc/crontabs/root
        echo "---"
        crond -f -l 2
    environment:
      - CRON_SCHEDULE=0 10 * * SUN
      - TZ=Europe/Rome
    depends_on:
      - common-api
    restart: unless-stopped
